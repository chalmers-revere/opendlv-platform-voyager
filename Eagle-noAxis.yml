# Copyright (C) 2019 Christian Berger
#
# This program is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 2
# of the License, or (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.

# Date: 2019-05-16

version: '2.3'

# These services run on Eagle (AMD APU).
services:
    ###########################################################################
    # opendlv-vehicle-view on 101.
    vehicle-view:
        container_name: opendlv-vehicle-view
        image: chalmersrevere/opendlv-vehicle-view-multi:v0.0.60
        cpuset: "1"
        restart: always
        network_mode: "host"
        volumes:
        - $HOME/recordings/lossy:/opt/vehicle-view/recordings
        - /var/run/docker.sock:/var/run/docker.sock
        environment:
        - OD4SESSION_CID=101
        - PLAYBACK_OD4SESSION_CID=201
        - OPENDLV_VEHICLE_VIEW_PLATFORM=Snowfox
        ports:
        - "8081:8081"
        cap_add:
        - SYS_NICE
        entrypoint: ""
        command: "nice -n -1 node index.js"
        runtime: runc

    ###########################################################################
    # Relay and downsample Envelopes from CID 102 (local CID session) to CID 101 (for opendlv-vehicle-view).
    relay-downsample-102-101:
        container_name: relay-downsample-102-101
        image: chrberger/cluon-relay-multi:v0.0.4
        cpuset: "1"
        restart: always
        network_mode: "host"
        cap_add:
        - SYS_NICE
        entrypoint: ""
        command: "nice -n -5 /usr/bin/cluon-relay --cid-from=102 --cid-to=101 --downsample=19:10,1046:10"
        runtime: runc

    ###########################################################################
    # Relay cluon.data.RecorderCommand.
    relay-recordercommand-101-102:
        container_name: relay-recordercommand-101-102
        image: chrberger/cluon-relay-multi:v0.0.4
        cpuset: "1"
        restart: always
        network_mode: "host"
        cap_add:
        - SYS_NICE
        entrypoint: ""
        command: "nice -n -7 /usr/bin/cluon-relay --cid-from=101 --cid-to=102 --keep=11"
        runtime: runc

    ###########################################################################
    # Dump all containers from CID 102 on request.
    record-102:
        container_name: record-102
        image: chrberger/cluon-record-multi:v0.0.1
        cpuset: "1"
        restart: always
        network_mode: "host"
        volumes:
        - $HOME/recordings/upload:/recordings
        working_dir: /recordings
        command: "--remote --recsuffix=-all --cid=102"
        runtime: runc


    ###########################################################################
    # CAN interface to receive GPS/IMU data.
    dlv-can-peak:
        container_name: dlv-can-peak
        image: chalmersrevere/opendlv-device-gps-peak-multi:v0.0.8
        cpuset: "1"
        restart: always
        network_mode: "host"
        privileged: true
        cap_add:
        - SYS_NICE
        entrypoint: ""
        command: "nice -n -1 /usr/bin/opendlv-device-gps-peak --can=can0 --cid=102 --id=0"
        runtime: runc


    ###########################################################################
    # Raw CAN interfaces to the truck.
    dlv-can-raw-1:
        container_name: dlv-can-raw-1
        image: chalmersrevere/opendlv-device-can-raw-multi:v0.0.2
        cpuset: "2"
        restart: always
        network_mode: "host"
        privileged: true
        cap_add:
        - SYS_NICE
        entrypoint: ""
        command: "nice -n -1 /usr/bin/opendlv-device-can-raw --can=can1 --cid=102 --id=1"
        runtime: runc

    dlv-can-raw-2:
        container_name: dlv-can-raw-2
        image: chalmersrevere/opendlv-device-can-raw-multi:v0.0.2
        cpuset: "2"
        restart: always
        network_mode: "host"
        privileged: true
        cap_add:
        - SYS_NICE
        entrypoint: ""
        command: "nice -n -1 /usr/bin/opendlv-device-can-raw --can=can2 --cid=102 --id=2"
        runtime: runc

    dlv-can-raw-3:
        container_name: dlv-can-raw-3
        image: chalmersrevere/opendlv-device-can-raw-multi:v0.0.2
        cpuset: "2"
        restart: always
        network_mode: "host"
        privileged: true
        cap_add:
        - SYS_NICE
        entrypoint: ""
        command: "nice -n -1 /usr/bin/opendlv-device-can-raw --can=can3 --cid=102 --id=3"
        runtime: runc

    dlv-can-raw-4:
        container_name: dlv-can-raw-4
        image: chalmersrevere/opendlv-device-can-raw-multi:v0.0.2
        cpuset: "2"
        restart: always
        network_mode: "host"
        privileged: true
        cap_add:
        - SYS_NICE
        entrypoint: ""
        command: "nice -n -1 /usr/bin/opendlv-device-can-raw --can=can4 --cid=102 --id=4"
        runtime: runc

    dlv-can-raw-5:
        container_name: dlv-can-raw-5
        image: chalmersrevere/opendlv-device-can-raw-multi:v0.0.2
        cpuset: "2"
        restart: always
        network_mode: "host"
        privileged: true
        cap_add:
        - SYS_NICE
        entrypoint: ""
        command: "nice -n -1 /usr/bin/opendlv-device-can-raw --can=can5 --cid=102 --id=5"
        runtime: runc

    dlv-can-raw-6:
        container_name: dlv-can-raw-6
        image: chalmersrevere/opendlv-device-can-raw-multi:v0.0.2
        cpuset: "2"
        restart: always
        network_mode: "host"
        privileged: true
        cap_add:
        - SYS_NICE
        entrypoint: ""
        command: "nice -n -1 /usr/bin/opendlv-device-can-raw --can=can6 --cid=102 --id=6"
        runtime: runc
